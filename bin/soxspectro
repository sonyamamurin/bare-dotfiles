#!/bin/bash

## soxspectro makes spectrograms of flac, wav and mp3's. One spectrogram for the whole file and one at the 1 minute mark for 4 seconds.
## Usage: soxspectro /path/to/directory/
## Dependencies: sox and optipng (optional)
## made by farligm/reversibel with help from ozymandias/ashmandias
## v1.1 (2nd official)


DIR="${1}"

#Fix for spaces in file names
SAVEIFS=$IFS
IFS=$(echo -en "\n\b")

#Checking for sox
if [[ "$(which sox >> /dev/null ; echo $?)" -ne "0" ]]; then
    echo "Unable to find sox in your PATH."
    exit 1
fi

#Checking for optipng
if [[ "$(which optipng >> /dev/null ; echo $?)" -eq "0" ]]; then
	OPTI=true
fi	


#Only process flac, wav and mp3.
for file in $(find $DIR -maxdepth 1 -iname \*flac -o -iname \*wav -o -iname \*mp3);do
	
	outfile_full="${file%.*}_full.png"
	outfile_partial="${file%.*}_partial.png"
	
	#Check if file already exists
    if [ ! -e "$outfile_full" ]; then
    	sox "$file" -n remix 1 spectrogram -x 3000 -Y 1200 -z 160 -w Kaiser -t "$file" -o "$outfile_full" 
		if [ $OPTI ]; then
			optipng -quiet "$outfile_full"
		fi
	else
        echo "$outfile_full already exists, not overwriting."		
    fi
	
	#Check if file already exists
	if [ ! -e "$outfile_partial" ]; then
		sox "$file" -n remix 1 spectrogram -x 500 -Y 800 -z 160 -w Kaiser -S 1:00 -d 0:04 -t "$file 1:00-1:04" -o"$outfile_partial"
		if [ $OPTI ]; then
			optipng -quiet "$outfile_partial"
		fi
    else
        echo "$outfile_partial already exists, not overwriting."		
    fi
	
done

IFS=$SAVEIFS